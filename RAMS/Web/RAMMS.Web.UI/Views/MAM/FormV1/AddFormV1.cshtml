@model RAMMS.Web.UI.Models.FormV1Model;
@using RAMMS.Business.ServiceProvider;
@{
    ViewBag.TabTitle = "INSTRUCTED WORKS";
    ViewData["Title"] = "INSTRUCTED WORKS";
    Layout = "~/Views/Shared/_PortalLayout.cshtml";
}
<link src="~/css/tui-time-picker.min.css" />
<script src="~/js/tui-time-picker.min.js" asp-append-version="true"></script>

@using (Html.BeginForm())
{
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">

                <div class="d-flex justify-content-center pt-3 pb-3">
                    <div class="form-group mb-0" style="width:400px; float:left">
                        <span style="width:100px;float:left;"> <label for="Form_C1_C2_No_" style="padding: .5rem .5rem 0 !important;">Reference No</label></span>
                        <span style="width:300px; float:left">
                            @Html.TextBoxFor(m => m.FormV1.RefId, new { @Id = "formV1ReferenceNo", @disabled = true, @class = "form-control  validate {required, Reference No}", style = "width:300px;" })
                        </span>

                    </div>
                </div>
            </div>
            <div class="modal-body mh-182 pt-0 pb-0">


                <div class="col-lg-12">
                    <div class="w-100 bg-white pt-3" style="border-top:1px solid #dee2e6;">
                        <div id="accordion" class="col-lg-12">
                            <div class="accordion custom-accordion mb-3" id="custom-accordion-zero">
                                <div class="card mb-0">
                                    <div class="card-header" id="headingZero">
                                        <h5 class="m-0">
                                            <a class="custom-accordion-title py-1" data-toggle="collapse" href="#AccordPage0" aria-expanded="true" aria-controls="collapseZero">
                                                <span class="float-left">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus-circle after-collapsed d-none"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-minus-circle before-collapsed d-none"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                                                </span>
                                                <span class="float-left" style="padding: 4px 8px;">
                                                    Form V1
                                                </span>
                                            </a>
                                        </h5>
                                    </div>
                                    <div id="AccordPage0" class="collapse show avowmodal-form formgrp-section" aria-labelledby="headingZero" data-parent="#custom-accordion-zero">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="form-group col-lg-10 col-md-12">
                                                    <div class="row">
                                                        <div class="col-lg-5">
                                                            <div class="row">
                                                                <div class="col-6 form-group pr-lg-0">
                                                                    <label for="RMU">RMU</label>
                                                                    @Html.DropDownListFor(Adtl => Adtl.FormV1.Rmu, (IEnumerable
<SelectListItem>)ViewData["RMU"], "Select RMU", new { @Id = "formV1rmu", @class = "form-control validate {required, RMU}" })

                                                                </div>
                                                                <div class="form-group col-lg-6 mb-0">
                                                                    <label for="RMU_Name">RMU Name</label>
                                                                    @Html.TextBoxFor(m => m.FormV1.RmuName, new { @Id = "formV1rmuDesc", @readonly = "readonly", @class = "form-control" })
                                                                </div>
                                                            </div>

                                                        </div>
                                                        <div class="col-lg-5">
                                                            <div class="row">
                                                                <div class="col-6 form-group px-0">
                                                                    <label for="RMU">Section Code</label>
                                                                    @Html.DropDownListFor(Ahdr => Ahdr.FormV1.SecCode, (IEnumerable<SelectListItem>)ViewData["SectionCodeList"], "Select Code", new { @Id = "formV1SecCode", @class = "form-control validate {required, Section Code}" })
                                                                    @Html.HiddenFor(Ahdr => Ahdr.FormV1.SecCode, new { @id = "hdnSecCode", @class = "form-control" })
                                                                    @Html.HiddenFor(m => m.SecCode, new { @id = "hdnFormV1SecCode", @class = "form-control" })
                                                                </div>
                                                                <div class="form-group col-lg-6 mb-0">
                                                                    <label for="RMU_Name">Section Name</label>
                                                                    @Html.TextBoxFor(m => m.SecDescription, new { @Id = "formV1SecDesc", @readonly = "readonly", @class = "form-control " })
                                                                </div>
                                                            </div>

                                                        </div>
                                                        <div class="col-2 form-group px-0">
                                                            <label for="RMU"> Division Code</label>
                                                            @Html.TextBoxFor(m => m.DivisionName, new { @Id = "formV1DivisionDesc", @readonly = "readonly", @class = "form-control " })
                                                        </div>
                                                        <div class="col-lg-5">

                                                            <div class="row">

                                                                <div class="form-group col-lg-6">
                                                                    <label for="Name_of_Crew_Supervisor">Crew</label>
                                                                    @Html.DropDownListFor(Ahdr => Ahdr.FormV1.Crew, (IEnumerable
<SelectListItem>)ViewData["Supervisor"], "Select Users", new { @Id = "formV1Crew", @class = "form-control  validate {required, Name of Crew Supervisor}" })

                                                                </div>
                                                                <div class="form-group col-lg-6">
                                                                    <label for="Name_of_Crew_Supervisor">Crew Name</label>
                                                                    @Html.TextBoxFor(Dhdr => Dhdr.FormV1.Crewname, "", new { @id = "formV1CrewName", @class = "form-control" })
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-5">
                                                            <div class="row">
                                                                <div class="col-lg-6 form-group px-0">
                                                                    <label for="Ref_No_">Activity Code</label>
                                                                    @Html.DropDownListFor(Adtl => Adtl.FormV1.ActCode, (IEnumerable
<SelectListItem>)ViewData["ActCode"], "Select Activity", new { @Id = "formV1Activity", @class = "form-control validate {required, Activity}" })

                                                                </div>
                                                                <div class="col-lg-6 form-group">
                                                                    <label for="Ref_No_">Activity Name</label>
                                                                    @Html.TextBoxFor(Dhdr => Dhdr.FormV1.ActName, "", new { @id = "formV1ActName", @class = "form-control" })
                                                                </div>
                                                            </div>
                                                        </div>


                                                        <div class="col-2 form-group px-0">
                                                            <label for="Division_Code">Date </label>
                                                            @Html.EditorFor(m => m.FormV1.Dt, new { type = "date", htmlAttributes = new { @class = "form-control" } })
                                                        </div>
                                                    </div>

                                                </div>
                                                <div class="form-group col-lg-2 col-md-12 pt-xl-4 px-md-4 px-sm-4">
                                                    <button id="btnFindDetails" type="button" onclick="Save('','')" class="btn btn-sm btn-themebtn col-md-12 col-xl-12 col-lg-2 mr-lg-1 float-right">Find Details</button>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="divFormV1Content">
                                @{
                                    Html.RenderPartial("_AddFormV1Content.cshtml",Model);
                                }
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
        <div class="col-md-12 float-right text-right custom-footer">
            <button type="button" class="btn btn-sm btn-outline-theme" onclick="GoBack()">Cancel</button>
            <button id="saveFormV1Btn" type="button" class="btn btn-sm btn-themebtn" onclick="Save('','')">Save</button>
            <button id="SubmitFormV1Btn" type="button" class="btn btn-sm btn-themebtn">Submit</button>
        </div>
    </div>

 

}

<style>

    .custom-tbl div.dataTables_scrollHead table thead tr th:nth-child(4), .custom-tbl div.dataTables_scrollBody table tbody tr td:nth-child(4), .custom-tbl div.dataTables_scrollHead table thead tr th:nth-child(2), .custom-tbl div.dataTables_scrollBody table tbody tr td:nth-child(2), .custom-tbl div.dataTables_scrollHead table thead tr th:nth-child(3), .custom-tbl div.dataTables_scrollBody table tbody tr td:nth-child(3), .custom-tbl div.dataTables_scrollHead table thead tr th:nth-child(4), .custom-tbl div.dataTables_scrollBody table tbody tr td:nth-child(4), .custom-tbl div.dataTables_scrollHead table thead tr th:nth-child(5), .custom-tbl div.dataTables_scrollBody table tbody tr td:nth-child(5) {
        width: auto !important;
        min-width: auto !important;
    }
</style>

<script>

    var onloadFlag = true;
    $(document).ready(function () {
        $('#formV1ReferenceNo').val("@Model.FormV1.Rmu");
        $('#formV1ReferenceNo').trigger('chosen:updated');

        $('#formV1SecCode').val("@Model.FormV1.SecCode");
        $('#formV1SecCode').trigger('chosen:updated');

        $('#ddlAcknowledgedby').val("@Model.FormV1.UseridAck");
        $('#ddlAcknowledgedby').trigger('chosen:updated');

        $('#ddlAgreedby').val("@Model.FormV1.UseridAgr");
        $('#ddlAgreedby').trigger('chosen:updated');

        $('#ddlScheduledby').val("@Model.FormV1.UseridSch");
        $('#ddlScheduledby').trigger('chosen:updated');

    });

    $("#formV1rmu").on("change", function () {
        var val = $(this).find(":selected").text();
        val = val.split("-").length > 0 ? val.split("-")[1] : val;
        $("#formV1rmuDesc").val(val);
        var req = {};
        req.Section = '';
        req.RoadCode = '';
        req.RMU = $("#formV1rmu option:selected").text().split("-")[1];

        debugger;
        //RM_div_RMU_Sec_Master
        $.ajax({
            url: '/ERT/RMUSecRoad',
            dataType: 'JSON',
            data: req,
            type: 'Post',
            success: function (data) {
                if (data != null) {
                    $("#formV1SecCode").empty();
                    $("#formV1SecCode").append($("<option></option>").val("").html("Select Section Code"));
                    $.each(data.section, function (index, v) {
                        $("#formV1SecCode").append($("<option></option>").val(v.value).html(v.text));
                    });
                    // var hdnRoadcode = $('#hdnRoadcode').val();
                    //$.each(data.section, function (index, v) {
                    //    var splittedVal = v.text.split("-")[0];
                    //    var editVal = $('#hdnRoadcode').val();
                    //    if (splittedVal == editVal) {
                    //        $("#formV1SecCode").val(v.value);
                    //    }
                    //});

                    if (onloadFlag) {
                        $("#formV1SecCode").val($("#hdnSecCode").val());
                        onloadFlag = false;
                    }

                    $('#formV1SecCode').trigger("chosen:updated");
                    $("#formV1SecCode").trigger("change");
                    document.getElementById("formV1SecDesc").disabled = true;


                } else {
                    document.getElementById("formV1SecDesc").disabled = false;
                }
            },
            error: function (data) {

                console.error(data);
            }
        });


    });

    $("#formV1rmu").trigger("change");


    $("#formV1SecCode").on("change", function () {
        //var d = new Date();
        var ddldata = $(this).val();

        if (ddldata != "") {
            $.ajax({
                url: '/ERT/GetAllRoadCodeDataBySectionCode',
                dataType: 'JSON',
                data: { secCode: $("#formV1SecCode option:selected").text().split("-")[0] },
                type: 'Post',
                success: function (data) {
                    if (data != null) {
                        if (data._RMAllData != undefined && data._RMAllData != null) {
                            $("#formV1SecDesc").val(data._RMAllData.secName);
                            $("#hdnformV1SecCode").val($("#formV1SecCode option:selected").text().split("-")[0]);
                            $("#formV1DivisionDesc").val(data._RMAllData.divisionCode);

                        }
                        document.getElementById("formV1DivisionDesc").disabled = true;
                    } else {
                        document.getElementById("formV1DivisionDesc").disabled = false;
                    }
                },
                error: function (data) {

                    console.error(data);
                }
            });
        }
        else {
            $("#formV1SecDesc").val("");
            $("#formV1DivisionDesc").val("");
        }

        return false;
    });


    $("#formV1Crew").on("change", function () {
        var id = $("#formV1Crew option:selected").val();
        if (id != "99999999" && id != "") {
            $.ajax({
                url: '/ERT/GetUserById',
                dataType: 'JSON',
                data: { id },
                type: 'Post',
                success: function (data) {
                    $("#formV1CrewName").val(data.userName);
                    $("#formV1CrewName").prop("disabled", true);

                    //if ($("#FDHRef_No").val() == "0" || $("#FDHRef_No").val() == "") {

                    //var text = "ERT/Form D/" + $("#formDroadCode").val() + "/" + month + "/" + maxcount + "-" + year
                    SetReferenceId();
                    //}
                },
                error: function (data) {
                    console.error(data);
                }
            });
        }
        else if (id == "99999999") {
            $("#formV1CrewName").prop("disabled", false);
            $("#formV1CrewName").val('');
        }
        else {
            $("#formV1CrewName").prop("disabled", true);
            $("#formV1CrewName").val('');
        }

        return false;
    });

    $("#formV1Crew").trigger("change");



    function OnRoadChange(tis) {

        var ctrl = $("#ddlRoadCode");
        $('#FormV1Dtl_RoadCode').val(ctrl.val());

        if (ctrl.find("option:selected").attr("fromkm") != undefined)
            $("#FormV1Dtl_FrmCh").val(ctrl.find("option:selected").attr("fromkm"));
        else
            $("#FormV1Dtl_FrmCh").val(ctrl.find("option:selected").attr("Item1"));

        if (ctrl.find("option:selected").attr("fromm") != undefined)
            $("#FormV1Dtl_ToChDeci").val(ctrl.find("option:selected").attr("fromm"));
        else
            $("#FormV1Dtl_ToChDeci").val(ctrl.find("option:selected").attr("Item2"));

        var obj = new Object();
        obj.TypeCode = ctrl.val();
        obj.Type = "RD_Code";
        getNameByCode(obj)

    }

    function getNameByCode(obj) {
        $.ajax({
            url: '/InstructedWorks/GetNameByCode',
            data: obj,
            type: 'Post',
            success: function (data) {

                if (obj.Type == "RD_Code") {
                    $("#FormV1Dtl_RoadName").val(data);
                }
            }
        })
    }


    function OnAcknowledgedChange(tis) {

        var ctrl = $(tis);
        if (ctrl.val() != null)
            $('#FormV1_UseridAck').val(ctrl.val());
        if ($('#FormV1_UseridAck').val() != "") {
            $("#FormV1_UsernameAck").val(ctrl.find("option:selected").attr("Item1"));
            $("#FormV1_DesignationAck").val(ctrl.find("option:selected").attr("Item2"));

            if ($('#FormV1_UseridAck').val() == "99999999") {
                $("#FormV1_UsernameAck").removeAttr("readonly");
                $("#FormV1_DesignationAck").removeAttr("readonly");

            } else {
                $("#FormV1_UsernameAck").attr("readonly", "true");
                $("#FormV1_DesignationAck").attr("readonly", "true");
            }
            $('#FormV1_SignAck').prop('checked', true);
        }
        else {
            $("#FormV1_UsernameAck").val('');
            $("#FormV1_DesignationAck").val('');
            $('#FormV1_SignAck').prop('checked', false);
        }
    }

    function OnAgreedbyChange(tis) {

        var ctrl = $(tis);
        if (ctrl.val() != null)
            $('#FormV1_UseridAgr').val(ctrl.val());
        if ($('#FormV1_UseridAgr').val() != "") {
            $("#FormV1_UsernameAgr").val(ctrl.find("option:selected").attr("Item1"));
            $("#FormV1_DesignationAgr").val(ctrl.find("option:selected").attr("Item2"));

            if ($('#FormV1_UseridAgr').val() == "99999999") {
                $("#FormV1_UsernameAgr").removeAttr("readonly");
                $("#FormV1_DesignationAgr").removeAttr("readonly");

            } else {
                $("#FormV1_UsernameAgr").attr("readonly", "true");
                $("#FormV1_DesignationAgr").attr("readonly", "true");
            }
            $('#FormV1_SignAgr').prop('checked', true);
        }
        else {
            $("#FormV1_UsernameAgr").val('');
            $("#FormV1_DesignationAgr").val('');
            $('#FormV1_SignAgr').prop('checked', false);
        }
    }

    function OnScheduledbyChange(tis) {

        var ctrl = $(tis);
        if (ctrl.val() != null)
            $('#FormV1_UseridSch').val(ctrl.val());
        if ($('#FormV1_UseridSch').val() != "") {
            $("#FormV1_UsernameSch").val(ctrl.find("option:selected").attr("Item1"));
            $("#FormV1_DesignationSch").val(ctrl.find("option:selected").attr("Item2"));

            if ($('#FormV1_UseridSch').val() == "99999999") {
                $("#FormV1_UsernameSch").removeAttr("readonly");
                $("#FormV1_DesignationSch").removeAttr("readonly");

            } else {
                $("#FormV1_UsernameSch").attr("readonly", "true");
                $("#FormV1_DesignationSch").attr("readonly", "true");
            }
            $('#FormV1_SignSch').prop('checked', true);
        }
        else {
            $("#FormV1_UsernameSch").val('');
            $("#FormV1_DesignationSch").val('');
            $('#FormV1_SignSch').prop('checked', false);
        }
    }



    function Save(GroupName, SubmitType) {

        debugger;

        $("#ddlUseridReq").removeClass("validate");
        $("#ddlUseridVer").removeClass("validate");
        $("#ddlUseridRep").removeClass("validate");
        $("#ddlRMU").removeClass("validate");

        $("#FormW1_SignReq").removeClass("validate");
        $("#FormW1_SignVer").removeClass("validate");
        $("#FormW1_SignRep").removeClass("validate");

        if (SubmitType != "") {

            $("#FormW1page .svalidate").addClass("validate");

            if (SubmitType == "Submitted") {
                $("#FormW1_Status").val("Submitted");
                $("#FormW1_SubmitSts").val(true);
                $("#ddlUseridReq").addClass("validate");
                $("#FormW1_SignReq").addClass("validate");


            }
            else if (SubmitType == "Verified") {
                $("#ddlUseridReq").addClass("validate");
                $("#ddlUseridVer").addClass("validate");
                $("#ddlRMU").addClass("validate");
                $("#ddlRMU").addClass("validate");
                $("#FormW1_IwRefNo").addClass("validate");
                $("#FormW1_SignVer").removeClass("validate");

                if ($("#hdnRecommondedValue").val() == 1 || $("#hdnRecommondedValue").val() == 2) {
                    $("#ddlUseridRep").addClass("validate");
                    $("#FormW1_SignRep").removeClass("validate");
                }
            }
        }
        else {
            $("#FormW1_Status").val("Saved");
        }

        if (ValidatePage('#FormW1page')) {
            InitAjaxLoading();
            $.post('/MAM/SaveFormV1', $("form").serialize(), function (data) {
                HideAjaxLoading();
                if (data == -1) {
                    app.ShowErrorMessage(data.errorMessage);
                }
                else {

                    if ($("#FormV1_PkRefNo").val() == "" || $("#FormV1_PkRefNo").val() == "0") {
                        $("#FormV1_PkRefNo").val(data);
                        $("#hdnPkRefNo").val(data);
                    }

                    if (SubmitType == "" ) {
                        app.ShowSuccessMessage('Saved Successfully', false);
                        $("#divFormV1Content").html(data);
                    }
                   else if ( SubmitType == "Saved") {
                        app.ShowSuccessMessage('Saved Successfully', false);
                         location.href = "/MAM/FormV1";
                    }
                    else if (SubmitType == "Submitted") {
                        app.ShowSuccessMessage('Submitted Successfully', false);
                        location.href = "/MAM/FormV1";
                    }
                    else if (SubmitType == "Verified") {
                        process.ShowApprove(GroupName, SubmitType);
                    }
                }
            });
        }



    }



    function SaveFormV1WorkSchedule() {

        debugger;

        if (ValidatePage('#FormW1page')) {
            InitAjaxLoading();
            $.post('/MAM/SaveFormV1WorkSchedule', $("form").serialize(), function (data) {
                HideAjaxLoading();
                if (data == -1) {
                    app.ShowErrorMessage(data.errorMessage);
                }
                else {
                    debugger;
                    if (data != 0)
                        $("#FormV1Dtl_PkRefNo").val(data)
                    InitializeGrid();
                        app.ShowSuccessMessage('Saved Successfully', false);
                }
            });
        }


    }
</script>
